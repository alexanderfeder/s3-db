/**
 * Entry point
 * @see https://bitbucket.org/sexycastle/s3-db/src
 */
module.exports=function(e){const t={db:"s3-db",appname:"app",environment:"dev",region:"us-west-2",s3:{bucket:{prefix:function(){return"s3-db."+t.appname+"."+t.environment+"-"},name:function(e){return this.prefix()+e},isOwned:function(e){return 0===this.prefix().length||e.startsWith(this.prefix())},parseName:function(e){return this.prefix().length>0?e.substring(this.prefix().length):e}},file:{spacer:null},pageSize:100},id:{name:"id",generator:require("uuid").v4}},n=e||t
return require("./s3-db")(n)},module.exports=function(e){const t=require("q"),n=require("./s3-db-bucket"),r=require("./s3-wrapper")(e),i={bucket:function(t){return new n(t,r,e)},list:function(){return r.listBuckets().then(function(i){var u=[]
return i.Buckets.forEach(function(t){e.s3.bucket.isOwned(t.Name)&&u.push({name:e.s3.bucket.parseName(t.Name),get:function(){return new n(this.name,r,e)},__meta:{createdOn:new Date(t.CreationDate)}})}),t(u)})},drop:function(t){if(!e.s3.allowDrop)throw"Configuration does not allow buckets to be dropped."},create:function(i,u){return e.s3.bucket.prefix(),r.createBucket(i).then(function(t){return u||(u={}),u["s3-db"]=e.appname,u["s3-db.environment"]=e.environment,r.putBucketTagging(i,u)}).then(function(){return t(new n(i,r,e))}).fail(function(e){return"BucketAlreadyOwnedByYou"===e.code?t.reject({status:"already-exists"}):"BucketAlreadyExists"===e.code?t.reject({status:"name-already-taken"}):t.reject({status:e.code})})}}
return{list:i.list,create:i.create,bucketOf:i.bucket}},module.exports=function(e,t,n){const r=require("q"),i={S3:null,configuration:null,bucket:null,_initialize:function(e,t,n){i.S3=t,i.configuration=n,i.bucket=e},_consistentMeta:function(e){var t={}
return e.Metadata&&(t=e.Metadata),e.Size&&(t.size=e.Size),e.ContentLength&&(t.size=e.ContentLength),e.ServerSideEncryption&&(t.encryption=e.ServerSideEncryption),e.LastModified&&(t.lastModified=new Date(e.LastModified)),e.ETag&&(t.eTag=e.ETag.replace(/"/g,"")),t},_listResponse:function(e){var t={hasMore:e.IsTruncated,batchSize:e.MaxKeys,resultCount:e.KeyCount,results:[]}
return e.Prefix&&(t.startsWith=e.Prefix),e.Contents.forEach(function(e){t.results.push({id:e.Key,get:function(){return i.load(e.Key)},__meta:i._consistentMeta(e)})}),[t,e]},_attachNext:function(e,t){return e.hasMore&&(e.next=function(){return i.S3.listObjects(i.bucket,e.startsWith,t.NextContinuationToken).then(function(e){return i._listResponse(e)}).spread(i._attachNext)}),r(e)},list:function(e){return i.S3.listObjects(i.bucket,e).then(function(e){return i._listResponse(e)}).spread(i._attachNext)},load:function(e){return i.S3.getObject(i.bucket,e).then(function(e){var t=e.Body.toString(),n=JSON.parse(t)
return n.__meta=i._consistentMeta(e),r(n)})},delete:function(e){return i.S3.deleteObject(i.bucket,e)},save:function(e){var t=i.configuration.id.name,n=e[t]||i.configuration.id.generator()
return e[t]||(e[t]=n),delete e.__meta,i.S3.putObject(i.bucket,e[t],e).then(function(t){return e.__meta=i._consistentMeta(t),r(e)})}}
return i._initialize(e,t,n),{list:i.list,load:i.load,delete:i.delete,save:i.save}},module.exports=function(e){const t=require("aws-sdk"),n=require("q"),r=e.region||process.env.AWS_REGION||process.env.AWS_DEFAULT_REGION,i=e.accessKeyId||null,u=e.secretAccessKey||null,s={region:r,accessKeyId:i,secretAccessKey:u},c=new t.S3(s),o={_hasNoerror:function(e,t,n){return!t||(e.reject(t),!1)},createBucket:function(t){var r=n.defer(),i={Bucket:e.s3.bucket.name(t),ACL:"private"}
return c.createBucket(i,function(e,t){o._hasNoerror(r,e,t)&&r.resolve(t)}),r.promise},putBucketTagging:function(t,r){var i=n.defer(),u={Bucket:e.s3.bucket.name(t),Tagging:{TagSet:[]}}
for(var s in r)u.Tagging.TagSet.push({Key:s,Value:r[s]})
return c.putBucketTagging(u,function(e,t){o._hasNoerror(i,e,t)&&i.resolve(t)}),i.promise},listBuckets:function(){var e=n.defer()
return c.listBuckets(function(t,n){o._hasNoerror(e,t,n)&&e.resolve(n)}),e.promise},listObjects:function(t,r,i){var u=n.defer(),s={Bucket:e.s3.bucket.name(t),FetchOwner:!1,MaxKeys:e.s3.pageSize}
return r&&(s.Prefix=r),i&&(s.ContinuationToken=i),c.listObjectsV2(s,function(e,t){o._hasNoerror(u,e,t)&&u.resolve(t)}),u.promise},deleteObject:function(t,r){var i=n.defer()
return c.deleteObject({Bucket:e.s3.bucket.name(t),Key:r},function(e,t){o._hasNoerror(i,e,t)&&i.resolve()}),i.promise},getObject:function(t,r){var i=n.defer()
return c.getObject({Bucket:e.s3.bucket.name(t),Key:r},function(e,t){o._hasNoerror(i,e,t)&&i.resolve(t)}),i.promise},putObject:function(t,r,i){var u=n.defer(),s=JSON.stringify(i,null,e.s3.file.spacer),a={Bucket:e.s3.bucket.name(t),Key:r,ContentType:"application/json",ContentLength:s.length,Body:s}
return i._metadata&&(a.Metadata=i._metadata,delete i._metadata),!e.s3.encryption==!1&&(a.ServerSideEncryption="AES256"),c.putObject(a,function(e,t){o._hasNoerror(u,e,t)&&u.resolve(t)}),u.promise}}
return{listBuckets:o.listBuckets,createBucket:o.createBucket,putBucketTagging:o.putBucketTagging,getObject:o.getObject,deleteObject:o.deleteObject,putObject:o.putObject,listObjects:o.listObjects}}
